name: MongoDB Example Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo
        ports:
          - 27017:27017
        options: --health-cmd "mongo --eval 'db.runCommand({ connectionStatus:\ 1 })'" --health-interval 5s --health-retries 10
    steps:
      - name: Wait for MongoDB to initialize
        run: |
          # Sleep to ensure MongoDB has started
          sleep 30

      - name: Create database, collection, and insert data into MongoDB
        run: |
          echo "
            use test_db;
            db.createCollection('users');
            db.users.insert({ name: 'Alice', age: 30 });
            db.users.insert({ name: 'Bob', age: 25 });
            db.users.find();
          " | docker exec -i ${{ job.services.mongodb.id }} mongo --eval "var db = db.getSiblingDB('test_db');" --quiet

      - name: Query the inserted data
        run: |
          docker exec ${{ job.services.mongodb.id }} mongo --eval "db = db.getSiblingDB('test_db'); db.users.find().pretty();"
